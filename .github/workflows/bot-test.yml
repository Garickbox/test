name: Test Telegram Bot

on:
  push:
    branches: [ main, master ]
    paths:
      - 'tg_bot/**'  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –±–æ—Ç–∞
  pull_request:
    branches: [ main, master ]
    paths:
      - 'tg_bot/**'
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions
  workflow_dispatch:
    inputs:
      test_name:
        description: '–ò–º—è —Ç–µ—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'
        required: false
        default: 'ttii7'

jobs:
  test-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
    - name: ‚öôÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        cache-dependency-path: 'tg_bot/package-lock.json'
    
    # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–æ—Ç–∞
    - name: üì¶ Install dependencies
      run: |
        echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        cd tg_bot
        npm ci --only=production
        echo "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
    
    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–¥–∞
    - name: üîç Lint and validate
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
        cd tg_bot
        
        echo "1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤..."
        [ -f "package.json" ] || exit 1
        [ -f "bot.js" ] || exit 1
        [ -f "services.js" ] || exit 1
        [ -f "students.js" ] || exit 1
        
        echo "2. –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json..."
        node -e "const pkg = require('./package.json'); console.log('–í–µ—Ä—Å–∏—è:', pkg.version); console.log('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:', Object.keys(pkg.dependencies || {}).length);"
        
        echo "3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å JavaScript..."
        node -c bot.js
        node -c services.js
        node -c students.js
        
        echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
    
    # 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–µ—Å—Ç–æ–≤ (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞)
    - name: üß™ Test config loading
      env:
        TEST_URL: 'https://garickbox.github.io/test/test/ttii7.js'
      run: |
        echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞..."
        cd tg_bot
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        cat > test_loader.js << 'EOF'
        const fetch = require('node-fetch');
        
        async function testLoader() {
          try {
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç —Å:', process.env.TEST_URL);
            const response = await fetch(process.env.TEST_URL);
            const jsCode = await response.text();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏
            const hasConfig = jsCode.includes('window.TEST_CONFIG');
            const hasQuestions = jsCode.includes('window.questionsBank');
            const hasProblems = jsCode.includes('window.problemsBank');
            
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:');
            console.log('- TEST_CONFIG:', hasConfig ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω');
            console.log('- questionsBank:', hasQuestions ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω');
            console.log('- problemsBank:', hasProblems ? '‚úÖ –ù–∞–π–¥–µ–Ω' : '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω');
            
            if (hasConfig && hasQuestions && hasProblems) {
              console.log('üéâ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');
              process.exit(0);
            } else {
              console.log('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–æ–º —Ç–µ—Å—Ç–∞');
              process.exit(1);
            }
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
            process.exit(1);
          }
        }
        
        testLoader();
        EOF
        
        node test_loader.js
    
    # 6. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
    - name: ü§ñ Test bot initialization
      env:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω (–Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π)
        BOT_TOKEN: 'test:token'
      run: |
        echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞..."
        cd tg_bot
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
        cat > test_bot_init.js << 'EOF'
        console.log('=== –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ ===');
        
        try {
          // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã
          console.log('1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π...');
          const { Telegraf } = require('telegraf');
          const { CONFIG, TestLoader, TestManager } = require('./services');
          const STUDENTS_DB = require('./students');
          
          console.log('‚úÖ –ú–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          
          // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          console.log('\n2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...');
          console.log('- Firebase project:', CONFIG.FIREBASE_ADMIN_KEY.project_id);
          console.log('- Bot token length:', CONFIG.BOT_TOKEN.length);
          console.log('- Students DB classes:', Object.keys(STUDENTS_DB.classes).length);
          
          // 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º TestLoader
          console.log('\n3. –¢–µ—Å—Ç–∏—Ä—É–µ–º TestLoader...');
          const loader = new TestLoader();
          const tests = loader.getAvailableTests();
          console.log('- –î–æ—Å—Ç—É–ø–Ω–æ —Ç–µ—Å—Ç–æ–≤:', tests.length);
          tests.forEach(t => console.log(`  ‚Ä¢ ${t.name}: ${t.title}`));
          
          // 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º TestManager
          console.log('\n4. –¢–µ—Å—Ç–∏—Ä—É–µ–º TestManager...');
          const manager = new TestManager();
          console.log('- Session map —Å–æ–∑–¥–∞–Ω');
          
          // 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑—É —É—á–µ–Ω–∏–∫–æ–≤
          console.log('\n5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑—É —É—á–µ–Ω–∏–∫–æ–≤...');
          const testStudent = STUDENTS_DB.getStudentById(701);
          console.log('- –£—á–µ–Ω–∏–∫ 701:', testStudent ? `${testStudent.lastName} ${testStudent.firstName}` : '–ù–µ –Ω–∞–π–¥–µ–Ω');
          
          const searchResults = STUDENTS_DB.searchStudents('–ò–≤–∞–Ω–æ–≤', '–ò–≤–∞–Ω', '7');
          console.log('- –ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤:', searchResults.length, '—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
          
          console.log('\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
          console.log('\n=== –ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É ===');
          console.log('–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:');
          console.log('1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
          console.log('2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Firebase');
          console.log('3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: npm start');
          
          process.exit(0);
          
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error.message);
          console.error(error.stack);
          process.exit(1);
        }
        EOF
        
        node test_bot_init.js
    
    # 7. –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
    - name: üìä Create test report
      if: always()
      run: |
        echo "=== –û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò ==="
        echo "–í—Ä–µ–º—è: $(date)"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "–ê–≤—Ç–æ—Ä: ${{ github.actor }}"
        echo ""
        echo "‚úÖ –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:"
        echo "1. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        echo "2. –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω"
        echo "3. –¢–µ—Å—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è"
        echo "4. –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è"
        echo ""
        echo "üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
        echo "- –î–æ–±–∞–≤—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π BOT_TOKEN –≤ Secrets"
        echo "- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–µ–ø–ª–æ–π –Ω–∞ Render/Railway"
        echo "- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º Telegram –±–æ—Ç–æ–º"
    
    # 8. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    - name: üì® Notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          echo "–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ."
        else
          echo "‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏."
        fi
