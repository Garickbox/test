<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест FCM Push-уведомлений (все в одном)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #FF5722;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }

        .status-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e0e0e0;
            min-height: 80px;
        }

        .status-item {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .token-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border: 2px solid #FF5722;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .notification-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px dashed #FF5722;
            display: none;
        }

        .notification-preview.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .demo-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #FF5722;
        }

        .demo-notification.show {
            display: flex;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .progress {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF5722, #E64A19);
            width: 0%;
            transition: width 0.5s;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab.active {
            background: #FF5722;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .instruction {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            .section {
                padding: 20px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-fire"></i> FCM Push-уведомления - Всё в одном HTML</h1>
            <p>Полный тест Firebase Cloud Messaging без внешних файлов</p>
        </div>
        
        <div class="content">
            <div class="tab-container">
                <button class="tab active" data-tab="test">Тестирование</button>
                <button class="tab" data-tab="config">Конфигурация</button>
                <button class="tab" data-tab="logs">Логи</button>
                <button class="tab" data-tab="help">Помощь</button>
            </div>
            
            <!-- Вкладка тестирования -->
            <div id="test" class="tab-content active">
                <div class="section">
                    <h3><i class="fas fa-check-circle"></i> 1. Проверка поддержки</h3>
                    <div class="status-box" id="supportStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-spinner fa-spin"></i> Проверка...
                        </div>
                    </div>
                    <button class="btn" id="checkSupport">
                        <i class="fas fa-sync-alt"></i> Проверить снова
                    </button>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-cogs"></i> 2. Service Worker</h3>
                    <div class="status-box" id="swStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-info-circle"></i> Нажмите "Создать Service Worker"
                        </div>
                    </div>
                    <button class="btn btn-success" id="createSW">
                        <i class="fas fa-plus-circle"></i> Создать Service Worker
                    </button>
                    <button class="btn" id="registerSW">
                        <i class="fas fa-download"></i> Зарегистрировать
                    </button>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-hand-paper"></i> 3. Разрешения</h3>
                    <div class="status-box" id="permStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-question-circle"></i> Разрешения не запрошены
                        </div>
                    </div>
                    <button class="btn btn-success" id="requestPerm">
                        <i class="fas fa-hand-paper"></i> Запросить разрешение
                    </button>
                    <button class="btn" id="checkPerm">
                        <i class="fas fa-eye"></i> Проверить статус
                    </button>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-key"></i> 4. Получение токена</h3>
                    <div class="status-box" id="tokenStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-key"></i> Нажмите "Получить токен"
                        </div>
                    </div>
                    <button class="btn btn-success" id="getToken">
                        <i class="fas fa-key"></i> Получить FCM токен
                    </button>
                    <button class="btn btn-info" id="copyToken">
                        <i class="fas fa-copy"></i> Копировать токен
                    </button>
                    
                    <div class="token-display" id="tokenDisplay" style="display: none;">
                        <strong>Ваш FCM токен:</strong><br>
                        <span id="tokenText"></span>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-bell"></i> 5. Тестирование уведомлений</h3>
                    <div class="status-box" id="notifStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-bell-slash"></i> Уведомления не тестировались
                        </div>
                    </div>
                    <button class="btn btn-success" id="sendLocal">
                        <i class="fas fa-bell"></i> Локальное уведомление
                    </button>
                    <button class="btn btn-warning" id="sendDelayed">
                        <i class="fas fa-clock"></i> Через 5 секунд
                    </button>
                    <button class="btn" id="sendCustom">
                        <i class="fas fa-edit"></i> Кастомное
                    </button>
                    
                    <div class="notification-preview" id="notifPreview">
                        <h4><i class="fas fa-eye"></i> Предпросмотр уведомления</h4>
                        <p>Это как будет выглядеть push-уведомление в вашем браузере.</p>
                    </div>
                </div>
                
                <div class="section">
                    <h3><i class="fas fa-wrench"></i> 6. Управление</h3>
                    <div class="status-box" id="manageStatus">
                        <div class="status-item status-info">
                            <i class="fas fa-info-circle"></i> Управление подпиской
                        </div>
                    </div>
                    <button class="btn btn-success" id="subscribe">
                        <i class="fas fa-check"></i> Подписаться
                    </button>
                    <button class="btn" id="unsubscribe">
                        <i class="fas fa-times"></i> Отписаться
                    </button>
                    <button class="btn btn-info" id="testPush">
                        <i class="fas fa-satellite-dish"></i> Тест Push
                    </button>
                </div>
            </div>
            
            <!-- Вкладка конфигурации -->
            <div id="config" class="tab-content">
                <div class="section">
                    <h3><i class="fas fa-cog"></i> Конфигурация Firebase</h3>
                    <div class="instruction">
                        <p><strong>Ваш проект:</strong> school-test-mrzo25</p>
                        <p><strong>Sender ID:</strong> 143703431012</p>
                        <p><strong>VAPID Key:</strong> fXynnSeXQP81-MahjlwfbpWeZuzwjnD03ej8ft2yQXI</p>
                    </div>
                    
                    <h4><i class="fas fa-code"></i> Код конфигурации:</h4>
                    <div class="token-display">
                        const firebaseConfig = {<br>
                        &nbsp;&nbsp;apiKey: "AIzaSyCox_zyQP5GMa5W9Tw2cUoBtvkQC-PcrsE",<br>
                        &nbsp;&nbsp;authDomain: "school-test-mrzo25.firebasestorage.app",<br>
                        &nbsp;&nbsp;projectId: "school-test-mrzo25",<br>
                        &nbsp;&nbsp;storageBucket: "school-test-mrzo25.firebasestorage.app",<br>
                        &nbsp;&nbsp;messagingSenderId: "143703431012",<br>
                        &nbsp;&nbsp;appId: "1:143703431012:web:b02bec2f8b28ce6e2acc71",<br>
                        &nbsp;&nbsp;measurementId: "G-MDJ60H5TBC"<br>
                        };
                    </div>
                    
                    <h4><i class="fas fa-shield-alt"></i> Service Worker код:</h4>
                    <div class="token-display" style="max-height: 300px; font-size: 11px;">
                        // firebase-messaging-sw.js<br>
                        importScripts('https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js');<br>
                        importScripts('https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js');<br><br>
                        
                        firebase.initializeApp({<br>
                        &nbsp;&nbsp;// Та же конфигурация<br>
                        });<br><br>
                        
                        const messaging = firebase.messaging();<br><br>
                        
                        messaging.onBackgroundMessage((payload) => {<br>
                        &nbsp;&nbsp;console.log('Фоновое сообщение:', payload);<br>
                        &nbsp;&nbsp;// Показать уведомление<br>
                        });
                    </div>
                </div>
            </div>
            
            <!-- Вкладка логов -->
            <div id="logs" class="tab-content">
                <div class="section">
                    <h3><i class="fas fa-terminal"></i> Логи выполнения</h3>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">[00:00:00] Запуск теста FCM...</div>
                    </div>
                    <button class="btn" id="clearLogs">
                        <i class="fas fa-trash"></i> Очистить логи
                    </button>
                    <button class="btn btn-info" id="exportLogs">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                </div>
            </div>
            
            <!-- Вкладка помощи -->
            <div id="help" class="tab-content">
                <div class="section">
                    <h3><i class="fas fa-question-circle"></i> Как использовать</h3>
                    <div class="instruction">
                        <p><strong>1. Проверьте поддержку</strong> - убедитесь, что браузер поддерживает все технологии</p>
                        <p><strong>2. Создайте Service Worker</strong> - нажмите кнопку "Создать Service Worker"</p>
                        <p><strong>3. Запросите разрешение</strong> - разрешите уведомления в браузере</p>
                        <p><strong>4. Получите токен</strong> - скопируйте FCM токен для использования</p>
                        <p><strong>5. Тестируйте</strong> - отправляйте локальные и push-уведомления</p>
                    </div>
                    
                    <h4><i class="fas fa-exclamation-triangle"></i> Важные моменты:</h4>
                    <div class="status-item status-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Push-уведомления работают только по HTTPS или localhost</span>
                    </div>
                    <div class="status-item status-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Для теста push-уведомлений сверните браузер после отправки</span>
                    </div>
                    <div class="status-item status-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Все данные хранятся только в вашем браузере</span>
                    </div>
                    
                    <h4><i class="fas fa-bug"></i> Решение проблем:</h4>
                    <div class="token-display" style="font-size: 12px;">
                        1. <strong>Уведомления не работают:</strong> Проверьте настройки браузера<br>
                        2. <strong>Service Worker не регистрируется:</strong> Откройте страницу по HTTPS<br>
                        3. <strong>Токен не получается:</strong> Обновите страницу и попробуйте снова<br>
                        4. <strong>Push не приходят:</strong> Сверните браузер после отправки<br>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Демо-уведомление -->
    <div class="demo-notification" id="demoNotification">
        <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;" id="demoTitle">Тест FCM</div>
            <div style="color: #666; font-size: 14px;" id="demoBody">Уведомление отправлено</div>
        </div>
        <button style="background: none; border: none; color: #95a5a6; cursor: pointer; font-size: 18px;" 
                onclick="document.getElementById('demoNotification').classList.remove('show')">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Встроенный Service Worker скрипт -->
    <script id="sw-script" type="text/javascript">
        // Этот скрипт будет скопирован в Service Worker
        // firebase-messaging-sw.js
        self.importScripts('https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js');
        self.importScripts('https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js');
        
        // Инициализация Firebase в Service Worker
        firebase.initializeApp({
            apiKey: "AIzaSyCox_zyQP5GMa5W9Tw2cUoBtvkQC-PcrsE",
            authDomain: "school-test-mrzo25.firebasestorage.app",
            projectId: "school-test-mrzo25",
            storageBucket: "school-test-mrzo25.firebasestorage.app",
            messagingSenderId: "143703431012",
            appId: "1:143703431012:web:b02bec2f8b28ce6e2acc71",
            measurementId: "G-MDJ60H5TBC"
        });
        
        const messaging = firebase.messaging();
        
        // Обработчик фоновых сообщений
        messaging.onBackgroundMessage(function(payload) {
            console.log('[Service Worker] Получено фоновое сообщение:', payload);
            
            const notificationTitle = payload.notification?.title || 'Новое уведомление';
            const notificationOptions = {
                body: payload.notification?.body || 'У вас новое сообщение',
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiNGRjU3MjIiPjxwYXRoIGQ9Ik0yMCAySDRjLTEuMSAwLTIgLjktMiAydjEyYzAgMS4xLjkgMiAyIDJoMTRsNCA0VjRjMC0xLjEtLjktMi0yLTJ6bS0yIDEySDZ2LTJoMTJ2MnptMC0zSDZWOWgxMnYyem0wLTNINlY2aDEydjJ6Ii8+PC9zdmc+',
                badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiPjxjaXJjbGUgY3g9IjI0IiBjeT0iMjQiIHI9IjI0IiBmaWxsPSIjRkY1NzIyIi8+PC9zdmc+',
                tag: 'fcm-test',
                requireInteraction: true,
                data: payload.data || {}
            };
            
            // Добавляем действия если поддерживается
            if ('actions' in Notification.prototype) {
                notificationOptions.actions = [
                    {action: 'open', title: 'Открыть тест'},
                    {action: 'close', title: 'Закрыть'}
                ];
            }
            
            // Показываем уведомление
            return self.registration.showNotification(notificationTitle, notificationOptions);
        });
        
        // Обработчик клика по уведомлению
        self.addEventListener('notificationclick', function(event) {
            console.log('Клик по уведомлению:', event.notification.tag);
            event.notification.close();
            
            const urlToOpen = self.location.origin + '/';
            
            event.waitUntil(
                self.clients.matchAll({
                    type: 'window',
                    includeUncontrolled: true
                }).then(function(clientList) {
                    // Ищем открытую вкладку
                    for (let i = 0; i < clientList.length; i++) {
                        const client = clientList[i];
                        if (client.url === urlToOpen && 'focus' in client) {
                            return client.focus();
                        }
                    }
                    
                    // Открываем новую вкладку
                    if (self.clients.openWindow) {
                        return self.clients.openWindow(urlToOpen);
                    }
                })
            );
        });
    </script>

    <!-- Основной скрипт -->
    <script>
        // Конфигурация
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCox_zyQP5GMa5W9Tw2cUoBtvkQC-PcrsE",
            authDomain: "school-test-mrzo25.firebasestorage.app",
            projectId: "school-test-mrzo25",
            storageBucket: "school-test-mrzo25.firebasestorage.app",
            messagingSenderId: "143703431012",
            appId: "1:143703431012:web:b02bec2f8b28ce6e2acc71",
            measurementId: "G-MDJ60H5TBC"
        };
        
        const VAPID_KEY = "fXynnSeXQP81-MahjlwfbpWeZuzwjnD03ej8ft2yQXI";
        
        // Глобальные переменные
        let messaging = null;
        let currentToken = null;
        let serviceWorkerRegistration = null;
        
        // Элементы DOM
        const logContainer = document.getElementById('logContainer');
        
        // Добавление логов
        function addLog(message, type = 'info') {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${time}] <span style="color: ${
                type === 'error' ? '#e74c3c' :
                type === 'success' ? '#2ecc71' :
                type === 'warning' ? '#f39c12' : '#3498db'
            }">${message}</span>`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Также в консоль
            console.log(`[FCM Test] ${message}`);
        }
        
        // Обновление статуса
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-times-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            element.innerHTML = `
                <div class="status-item status-${type}">
                    <i class="fas ${icon}"></i>
                    ${message}
                </div>
            `;
        }
        
        // Показать демо-уведомление
        function showDemoNotification(title, body, type = 'info') {
            const notification = document.getElementById('demoNotification');
            const titleEl = document.getElementById('demoTitle');
            const bodyEl = document.getElementById('demoBody');
            
            titleEl.textContent = title;
            bodyEl.textContent = body;
            
            // Цвет в зависимости от типа
            notification.style.borderLeftColor = 
                type === 'error' ? '#e74c3c' :
                type === 'warning' ? '#f39c12' :
                type === 'success' ? '#2ecc71' : '#3498db';
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        // Проверка поддержки
        function checkSupport() {
            const tests = [
                {name: 'Service Worker', test: () => 'serviceWorker' in navigator},
                {name: 'Push API', test: () => 'PushManager' in window},
                {name: 'Notification API', test: () => 'Notification' in window},
                {name: 'Firebase Messaging', test: () => typeof firebase !== 'undefined'},
                {name: 'HTTPS или localhost', test: () => 
                    window.location.protocol === 'https:' || 
                    window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1'
                }
            ];
            
            let allPassed = true;
            const statusBox = document.getElementById('supportStatus');
            statusBox.innerHTML = '';
            
            tests.forEach(test => {
                const passed = test.test();
                allPassed = allPassed && passed;
                
                const statusItem = document.createElement('div');
                statusItem.className = `status-item ${passed ? 'status-success' : 'status-error'}`;
                statusItem.innerHTML = `
                    <i class="fas ${passed ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                    ${test.name}: ${passed ? 'Поддерживается' : 'Не поддерживается'}
                `;
                statusBox.appendChild(statusItem);
            });
            
            if (allPassed) {
                addLog('Все проверки пройдены успешно', 'success');
            } else {
                addLog('Некоторые функции не поддерживаются', 'warning');
            }
            
            return allPassed;
        }
        
        // Создание Service Worker из встроенного скрипта
        async function createServiceWorker() {
            try {
                addLog('Создание Service Worker...', 'info');
                
                // Получаем код Service Worker из встроенного скрипта
                const swScript = document.getElementById('sw-script').textContent;
                
                // Создаем Blob из кода
                const blob = new Blob([swScript], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(blob);
                
                // Регистрируем Service Worker
                serviceWorkerRegistration = await navigator.serviceWorker.register(swURL);
                
                addLog('Service Worker создан и зарегистрирован', 'success');
                updateStatus('swStatus', 'Service Worker готов к работе', 'success');
                showDemoNotification('Service Worker создан', 'Теперь можно запрашивать разрешения', 'success');
                
                return true;
            } catch (error) {
                addLog('Ошибка создания Service Worker: ' + error.message, 'error');
                updateStatus('swStatus', 'Ошибка создания Service Worker', 'error');
                return false;
            }
        }
        
        // Регистрация Service Worker
        async function registerServiceWorker() {
            try {
                if (!serviceWorkerRegistration) {
                    throw new Error('Сначала создайте Service Worker');
                }
                
                addLog('Активация Service Worker...', 'info');
                
                // Инициализируем Firebase Messaging
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                
                messaging = firebase.messaging();
                
                // Используем Service Worker
                messaging.useServiceWorker(serviceWorkerRegistration);
                
                // Настраиваем обработчик входящих сообщений
                messaging.onMessage((payload) => {
                    console.log('Сообщение получено (приложение активно):', payload);
                    addLog('Получено push-сообщение', 'success');
                    
                    showDemoNotification(
                        payload.notification?.title || 'Новое сообщение',
                        payload.notification?.body || 'У вас новое сообщение',
                        'info'
                    );
                });
                
                addLog('Firebase Messaging инициализирован', 'success');
                showDemoNotification('Готово!', 'Firebase Messaging инициализирован', 'success');
                
                return true;
            } catch (error) {
                addLog('Ошибка регистрации: ' + error.message, 'error');
                return false;
            }
        }
        
        // Запрос разрешения на уведомления
        async function requestPermission() {
            try {
                addLog('Запрос разрешения на уведомления...', 'info');
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    addLog('Разрешение на уведомления получено', 'success');
                    updateStatus('permStatus', 'Разрешение получено', 'success');
                    showDemoNotification('Разрешение получено!', 'Теперь можно получать уведомления', 'success');
                    return true;
                } else if (permission === 'denied') {
                    addLog('Разрешение на уведомления отклонено', 'error');
                    updateStatus('permStatus', 'Разрешение отклонено', 'error');
                    return false;
                } else {
                    addLog('Разрешение не предоставлено', 'warning');
                    updateStatus('permStatus', 'Разрешение не предоставлено', 'warning');
                    return false;
                }
            } catch (error) {
                addLog('Ошибка запроса разрешения: ' + error.message, 'error');
                return false;
            }
        }
        
        // Получение FCM токена
        async function getFCMToken() {
            try {
                if (!messaging) {
                    throw new Error('Firebase Messaging не инициализирован');
                }
                
                if (Notification.permission !== 'granted') {
                    throw new Error('Разрешение на уведомления не получено');
                }
                
                addLog('Получение FCM токена...', 'info');
                
                // Получаем токен
                currentToken = await messaging.getToken({
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: serviceWorkerRegistration
                });
                
                if (currentToken) {
                    // Сохраняем токен
                    localStorage.setItem('fcmToken', currentToken);
                    
                    // Показываем токен
                    document.getElementById('tokenText').textContent = currentToken;
                    document.getElementById('tokenDisplay').style.display = 'block';
                    
                    addLog('FCM токен получен успешно', 'success');
                    updateStatus('tokenStatus', 'Токен получен', 'success');
                    
                    // Автоматически копируем в буфер
                    navigator.clipboard.writeText(currentToken).then(() => {
                        addLog('Токен скопирован в буфер обмена', 'info');
                    });
                    
                    showDemoNotification('Токен получен!', 'FCM токен успешно сгенерирован', 'success');
                    
                    return currentToken;
                } else {
                    throw new Error('Не удалось получить токен');
                }
            } catch (error) {
                addLog('Ошибка получения токена: ' + error.message, 'error');
                updateStatus('tokenStatus', 'Ошибка получения токена', 'error');
                return null;
            }
        }
        
        // Отправка локального уведомления
        function sendLocalNotification() {
            try {
                if (Notification.permission !== 'granted') {
                    throw new Error('Разрешение на уведомления не получено');
                }
                
                const title = 'Тестовое локальное уведомление';
                const body = `Отправлено: ${new Date().toLocaleTimeString()}`;
                
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiNGRjU3MjIiPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPjwvc3ZnPg==',
                    tag: 'test-notification',
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                    addLog('Локальное уведомление кликнуто', 'info');
                };
                
                addLog('Локальное уведомление отправлено', 'success');
                updateStatus('notifStatus', 'Уведомление отправлено', 'success');
                
                // Показываем предпросмотр
                document.getElementById('notifPreview').classList.add('show');
                setTimeout(() => {
                    document.getElementById('notifPreview').classList.remove('show');
                }, 3000);
                
                // Автоматическое закрытие
                setTimeout(() => notification.close(), 8000);
                
            } catch (error) {
                addLog('Ошибка отправки уведомления: ' + error.message, 'error');
                updateStatus('notifStatus', 'Ошибка отправки', 'error');
            }
        }
        
        // Отправка отложенного уведомления
        function sendDelayedNotification() {
            addLog('Запуск таймера (5 секунд)...', 'info');
            showDemoNotification('Таймер запущен', 'Через 5 секунд придет уведомление', 'warning');
            
            let seconds = 5;
            const timer = setInterval(() => {
                if (seconds > 0) {
                    addLog(`Таймер: ${seconds} сек...`, 'info');
                    seconds--;
                } else {
                    clearInterval(timer);
                    if (Notification.permission === 'granted') {
                        sendLocalNotification();
                        addLog('Отложенное уведомление отправлено', 'success');
                    }
                }
            }, 1000);
        }
        
        // Подписка на уведомления
        async function subscribeToNotifications() {
            try {
                if (!serviceWorkerRegistration) {
                    throw new Error('Service Worker не зарегистрирован');
                }
                
                addLog('Подписка на уведомления...', 'info');
                
                // Создаем Service Worker если нужно
                if (!messaging) {
                    await registerServiceWorker();
                }
                
                // Запрашиваем разрешение
                await requestPermission();
                
                // Получаем токен
                await getFCMToken();
                
                addLog('Подписка успешно оформлена', 'success');
                updateStatus('manageStatus', 'Подписка активна', 'success');
                showDemoNotification('Подписка оформлена', 'Вы подписаны на уведомления', 'success');
                
            } catch (error) {
                addLog('Ошибка подписки: ' + error.message, 'error');
            }
        }
        
        // Отписка от уведомлений
        async function unsubscribeFromNotifications() {
            try {
                if (messaging && currentToken) {
                    await messaging.deleteToken();
                    currentToken = null;
                    localStorage.removeItem('fcmToken');
                    
                    document.getElementById('tokenDisplay').style.display = 'none';
                    
                    addLog('Отписка от уведомлений выполнена', 'success');
                    updateStatus('manageStatus', 'Отписка выполнена', 'success');
                    showDemoNotification('Отписано', 'Вы отписались от уведомлений', 'success');
                } else {
                    addLog('Нет активной подписки', 'warning');
                }
            } catch (error) {
                addLog('Ошибка отписки: ' + error.message, 'error');
            }
        }
        
        // Копирование токена
        function copyTokenToClipboard() {
            if (!currentToken) {
                showDemoNotification('Ошибка', 'Токен не получен', 'error');
                return;
            }
            
            navigator.clipboard.writeText(currentToken).then(() => {
                addLog('Токен скопирован в буфер обмена', 'success');
                showDemoNotification('Скопировано', 'Токен скопирован', 'success');
            }).catch(err => {
                addLog('Ошибка копирования: ' + err.message, 'error');
            });
        }
        
        // Тест push-уведомления
        async function testPushNotification() {
            try {
                if (!currentToken) {
                    throw new Error('Токен не получен');
                }
                
                addLog('Тестирование push-уведомления...', 'info');
                showDemoNotification(
                    'Тест push-уведомления',
                    'В реальном проекте здесь будет запрос к серверу FCM',
                    'info'
                );
                
                // Пример кода для реальной отправки:
                /*
                const response = await fetch('https://fcm.googleapis.com/fcm/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'key=ВАШ_SERVER_KEY',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: currentToken,
                        notification: {
                            title: 'Тестовое push-уведомление',
                            body: 'Отправлено через FCM API',
                            icon: '/icon.png'
                        }
                    })
                });
                */
                
                addLog('Push-уведомление отправлено (эмуляция)', 'success');
                updateStatus('notifStatus', 'Push-тест выполнен', 'success');
                
            } catch (error) {
                addLog('Ошибка теста push: ' + error.message, 'error');
            }
        }
        
        // Отправка кастомного уведомления
        function sendCustomNotification() {
            const title = prompt('Заголовок уведомления:', 'Кастомное уведомление');
            if (!title) return;
            
            const body = prompt('Текст уведомления:', 'Это кастомное сообщение');
            if (!body) return;
            
            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiNGRjU3MjIiPjxwYXRoIGQ9Ik0xOC40MSA3LjQxTDE3IDZsLTYgNi0yLjU5LTIuNTlMNiAxM2wyLjQxIDIuNDFMMTAgMTNsNiA2IDEwLTEwLTIuNTktMi41OXpNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6Ii8+PC9zdmc+'
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
                addLog('Кастомное уведомление отправлено: ' + title, 'success');
                setTimeout(() => notification.close(), 5000);
            }
        }
        
        // Очистка логов
        function clearLogs() {
            logContainer.innerHTML = '<div class="log-entry">[00:00:00] Логи очищены</div>';
            addLog('Логи очищены', 'info');
        }
        
        // Экспорт логов
        function exportLogs() {
            const logs = logContainer.innerText;
            const blob = new Blob([logs], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fcm-test-logs.txt';
            a.click();
            
            URL.revokeObjectURL(url);
            addLog('Логи экспортированы', 'success');
        }
        
        // Переключение вкладок
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Убираем активный класс у всех
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс текущей
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }
        
        // Проверка сохраненного токена
        function checkSavedToken() {
            const savedToken = localStorage.getItem('fcmToken');
            if (savedToken) {
                currentToken = savedToken;
                document.getElementById('tokenText').textContent = currentToken;
                document.getElementById('tokenDisplay').style.display = 'block';
                addLog('Найден сохраненный токен', 'success');
            }
        }
        
        // Инициализация
        async function init() {
            try {
                // Загружаем Firebase SDK
                await loadFirebaseSDK();
                
                // Инициализация вкладок
                initTabs();
                
                // Проверяем сохраненный токен
                checkSavedToken();
                
                // Проверяем поддержку
                checkSupport();
                
                // Назначаем обработчики
                document.getElementById('checkSupport').addEventListener('click', checkSupport);
                document.getElementById('createSW').addEventListener('click', createServiceWorker);
                document.getElementById('registerSW').addEventListener('click', registerServiceWorker);
                document.getElementById('requestPerm').addEventListener('click', requestPermission);
                document.getElementById('checkPerm').addEventListener('click', () => {
                    const status = Notification.permission;
                    addLog(`Статус разрешений: ${status}`, 'info');
                    updateStatus('permStatus', `Статус: ${status}`, 
                        status === 'granted' ? 'success' :
                        status === 'denied' ? 'error' : 'warning');
                });
                document.getElementById('getToken').addEventListener('click', getFCMToken);
                document.getElementById('copyToken').addEventListener('click', copyTokenToClipboard);
                document.getElementById('sendLocal').addEventListener('click', sendLocalNotification);
                document.getElementById('sendDelayed').addEventListener('click', sendDelayedNotification);
                document.getElementById('sendCustom').addEventListener('click', sendCustomNotification);
                document.getElementById('subscribe').addEventListener('click', subscribeToNotifications);
                document.getElementById('unsubscribe').addEventListener('click', unsubscribeFromNotifications);
                document.getElementById('testPush').addEventListener('click', testPushNotification);
                document.getElementById('clearLogs').addEventListener('click', clearLogs);
                document.getElementById('exportLogs').addEventListener('click', exportLogs);
                
                addLog('Инициализация завершена', 'success');
                showDemoNotification('Готово!', 'Тест FCM инициализирован', 'success');
                
            } catch (error) {
                addLog('Ошибка инициализации: ' + error.message, 'error');
            }
        }
        
        // Загрузка Firebase SDK
        function loadFirebaseSDK() {
            return new Promise((resolve, reject) => {
                if (typeof firebase !== 'undefined') {
                    resolve();
                    return;
                }
                
                addLog('Загрузка Firebase SDK...', 'info');
                
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js';
                script1.onload = () => {
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js';
                    script2.onload = () => {
                        addLog('Firebase SDK загружен', 'success');
                        resolve();
                    };
                    script2.onerror = reject;
                    document.head.appendChild(script2);
                };
                script1.onerror = reject;
                document.head.appendChild(script1);
            });
        }
        
        // Запуск при загрузке страницы
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>